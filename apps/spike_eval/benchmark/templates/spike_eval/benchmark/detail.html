{% extends "spike_eval/benchmark/base.html" %}

{% load i18n %}
{% load spike_eval_tags %}
{% load bootstrap_tags %}

{% block head_title %}{B:{{ b.id }}}&nbsp;{{ b.name }}{% endblock %}

{% block content %}

  <header class="jumbotron subnav">
    <h2>{{ b }}{% ifequal b.state 30 %}&nbsp;(CLOSED){% endifequal %}</h2>
    <dl class="dl-horizontal">
      <dt>
        <strong>Description:</strong>
      </dt>
      <dd>
        {{ b.description }}
      </dd>
      <dt>
        <strong>Owner:</strong>
      </dt>
      <dd>
        <nobr>
          <i class=" icon-user"></i>
          <a href="{% url profile_detail b.owner.username %}">
            {{ b.owner.username }}
          </a>
          {% ifequal b.owner request.user %}(you){% endifequal %}
        </nobr>
      </dd>
      <dt>
        <strong>Date Created:</strong>
      </dt>
      <dd>
        <nobr><i class="icon-time"></i>
          {{ b.date_created|date }}</nobr>
      </dd>
      {% ifequal b.owner request.user %}
        <dt>
          <strong>Status:</strong>
        </dt>
        <dd>
          {% if b.is_active %}
            <i class="icon-ok"></i>
            <b style="color: green">ACTIVE</b> - available for user download
          {% else %}
            <i class="icon-lock"></i>
            <b style="color: red">INACTIVE</b> - for your eyes only
          {% endif %}
        </dd>
      {% endifequal %}
      <dt>
        <strong>Tags:</strong>
      </dt>
      <dd>
        {% for tag in b.tags.all %}
          <i class="icon-tag"></i>{{ tag }}&nbsp;
        {% endfor %}
      </dd>
    </dl>
  </header>

  {% if user.is_authenticated %}
    {% ifequal b.owner user %}
      <form class="form well">
        <span class="label">Actions:</span>
        <a id="edit-benchmark-toggle" class="btn btn-mini">
          {% trans "Edit Benchmark" %}</a>
        <a id="create-trial-toggle" class="btn btn-mini">
          {% trans "Create Trial" %}</a>
        <a id="create-suppl-toggle" class="btn btn-mini">
          {% trans "Create Supplementary" %}</a>
      </form>
      <form id="edit-benchmark" method="POST" style="display:none"
       class="form form-horizontal well">
        <fieldset>
          <legend>Edit Benchmark</legend>
          {% csrf_token %}
          {{ b_form|as_bootstrap }}
          <div class="form-actions">
            <input type="submit" class="btn btn-primary" name="b_edit"
             value="{% trans 'Edit Benchmark' %}"/>
          </div>
        </fieldset>
      </form>
      <form id="create-trial" method="POST" enctype="multipart/form-data"
       style="display:none" class="form form-horizontal well">
        <fieldset>
          <legend>Create Trial</legend>
          {% csrf_token %}
          {{ t_form|as_bootstrap }}
          <div class="form-actions">
            <input type="submit" class="btn btn-primary" name="t_create"
             value="{% trans 'Create Trial' %}"/>
          </div>
        </fieldset>
      </form>
      <form id="create-suppl" method="POST" enctype="multipart/form-data"
       style="display:none" class="form form-horizontal well">
        <fieldset>
          <legend>Create Supplementary</legend>
          {% csrf_token %}
          {{ s_form|as_bootstrap }}
          <div class="form-actions">
            <input type="submit" class="btn btn-primary" name="s_create"
             value="{% trans 'Create Supplementary' %}"/>
          </div>
        </fieldset>
      </form>
    {% endifequal %}
  {% endif %}

  <div>
    <h2>Trial Set</h2>

    <p>Benchmarks consist of one or more Trials. You may download Trials and
      apply your spike sorting algorithm. After the spike sorting on your
      end, you can may upload the resulting spike train set here and start an
      Evaluation.</p>

    {% if t_list %}
      <table class="table table-striped table-condensed">
        <thead>
        <tr>
          <th>{% trans "Name" %}</th>
          <th>{% trans "Created" %}</th>
          <th>{{ b.parameter }}</th>
          <th>{% trans "Description" %}</th>
          <th>{% trans "Evaluations" %}</th>
          <th>{% trans "Download" %}</th>
          {% ifequal b.owner user %}
            <th>{% trans "Status" %}</th>
          {% endifequal %}
        </tr>
        </thead>
        <tbody>
        {% for t in t_list %}
          <tr>
            <td>
              {% ifequal b.owner user %}
                <a href="{{ t.get_absolute_url }}">
              {% endifequal %}
              <nobr><strong>{{ t }}</strong></nobr>
              {% ifequal b.owner user %}
                </a>
              {% endifequal %}
            </td>
            <td>
              <nobr>
                <i class="icon-time"></i>
                {{ t.date_created|date }}
              </nobr>
            </td>
            <td>
              {{ t.parameter }}
            </td>
            <td>
              {{ t.description|truncate:100|escape }}
            </td>
            <td>
              {% if t.eval_count %}
                <a href="{% url e_list bid=b.id tid=t.id %}">
                  {% trans "view evaluations" %}({{ t.eval_count }})
                </a>
              {% else %}
                {% trans "no evaluations yet" %}
              {% endif %}
            </td>
            {% with t.rd_file as f %}
              <td>
                <nobr>
                  <a href="{{ f.get_absolute_url }}">
                    {{ f.name }} - {{ f.size|filesizeformat }}
                  </a>
                </nobr>
                {% if b.gt_access == 20 %}
                  {% with t.gt_file as f %}
                    </br>
                    <nobr>
                      <a href="{{ f.get_absolute_url }}">
                        {{ f.name }} - {{ f.size|filesizeformat }}
                      </a>
                    </nobr>
                  {% endwith %}
                {% endif %}
              </td>
            {% endwith %}
            {% ifequal b.owner user %}
              <td>
                {% if t.is_validated %}
                  <i class="icon-ok"></i>
                  <strong style="color: green">VALID</strong>
                {% else %}
                  <i class="icon-exclamation-sign"></i>
                  <strong style="color: red">INVALID</strong>
                {% endif %}
              </td>
            {% endifequal %}
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>This benchmark has no trials yet.</p>
      {% ifequal b.owner request.user %}
        <p>You can add new trials by clicking on the "Create Trial" button
          above.</p>
      {% endifequal %}
    {% endif %}
  </div>

  <div>
    <h2>Supplementary Files</h2>

    <p>List of Supplementaries describing the Benchmarks and its Trials.</p>

    {% if b.datafile_set %}
      <table class="table table-striped table-condensed">
        <thead>
        <tr>
          <th>{% trans "Name" %}</th>
          <th>{% trans "Filename" %}</th>
          <th>{% trans "Size" %}</th>
          <th>{% trans "Created" %}</th>
        </tr>
        </thead>
        <tbody>
        {% for d in b.datafile_set %}
          <tr>
            <td>
              <nobr>{{ d.name }}</nobr>
            </td>
            <td>
              <nobr>
                <a href="{{ d.get_absolute_url }}">{{ d.file.name }}</a>
              </nobr>
            </td>
            <td>
              {{ d.size|filesizeformat }}
            </td>
            <td>
              <nobr>
                <i class="icon-time"></i>
                {{ d.date_created|date }}
              </nobr>
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>This Benchmark has no Supplementaries yet.
        {% ifequal b.owner request.user %}
          You can add new Supplementary Files by clicking on the "Create
          Supplementary" button under "Actions:" above.
        {% endifequal %}
      </p>
    {% endif %}
  </div>

  <div>
    <h2>Submit Evaluation</h2>

    <p>Submit your spike sorting here to start an Evaluation.</p>
    {% if not user.is_authenticated %}
      <p>Please log in to submit for this Benchmark!</p>
    {% else %}
      {% if e_forms %}
        <form method="POST" enctype="multipart/form-data"
         class="form form-inline well">
          <fieldset>
          <legend>Submit Evaluation</legend>
            {% csrf_token %}
            {% for e_form in e_forms %}
              <div style="float: left;">
                <legend>Trial: {{ e_form.trial }}</legend>
                {{ e_form|as_bootstrap }}
              </div>
            {% endfor %}
            <div class="form-actions" style="clear: both;">
              <input type="submit" class="btn btn-primary" name="e_submit"
               value="{% trans 'Submit Evaluations' %}"/>
            </div>
          </fieldset>
        </form>
      {% else %}
        There are no Trials for this Benchmark!
      {% endif %}
    {% endif %}
  </div>
{% endblock %}

{% block extra_body %}
  <script type="text/javascript">
    $(document).ready(function() {
      $('#edit-benchmark-toggle').click(function() {
        $('#create-trial').hide();
        $('#create-suppl').hide();
        $('#edit-benchmark').toggle();
        return false;
      });
      if($('#edit-benchmark .error').length) {
        $('#edit-benchmark').show();
        $('#edit-benchmark .error').autoscroll();
      }
      ;
      $('#create-trial-toggle').click(function() {
        $('#edit-benchmark').hide();
        $('#create-suppl').hide();
        $('#create-trial').toggle();
        return false;
      });
      if($('#create-trial .error').length) {
        $('#create-trial').show();
        $('#create-trial .error').autoscroll();
      }
      ;
      $('#create-suppl-toggle').click(function() {
        $('#edit-benchmark').hide();
        $('#create-trial').hide();
        $('#create-suppl').toggle();
        return false;
      });
      if($('#create-suppl .error').length) {
        $('#create-suppl').show();
        $('#create-suppl .error').autoscroll();
      }
      ;
    });
  </script>
{% endblock %}
