{% extends "datasets/base.html" %}

{% load i18n %}
{% load uni_form %}
{% load pagination_tags %}
{% load extra_tagging_tags %}
{% load truncate_filter %}

{% block head_title %}{{ dataset.title }}{% endblock %}

{% block extra_head %}
	<link type="text/css" rel="stylesheet" href="{{ STATIC_URL }}css/shCore.css"/> 
	<link type="text/css" rel="stylesheet" href="{{ STATIC_URL }}css/shThemeDefault.css"/>
	<link type="text/css" rel="stylesheet" href="{{ STATIC_URL }}css/shTreeDemo.css"/>  
{% endblock %}

{% block body %}
    
    {% if dataset %}

        {% ifequal dataset.owner request.user %}
            <div class="right_panel">
                <div class="friends">
                    {% if dataset.is_Public %}
                    <h2>{% trans "Privacy" %}</h2>
                    <p>This dataset is <b style="color: red">Public</b> and available for other users. Objects, linked to this dataset, have specific privacy settings and may NOT be accessible to others.</p>
                    {% else %}
                    <h2>{% trans "Shared with:" %}</h2>
                        {% if dataset.is_Friendly %}
                            <p>All people you know
                            {% if dataset.shared_with.all %}
                            , and </p>
                                {% for exp_member in dataset.shared_with.all %}
                                        <span><a href="{% url profile_detail exp_member.username %}" title="{{ exp_member.username }}">{{ exp_member.username }}</a>, </span>
                                {% endfor %}
                            {% else %}
                                .</p>
                            {% endif %}
                        {% else %}
                            {% if dataset.shared_with.all %}
                                {% for exp_member in dataset.shared_with.all %}
                                        <span><a href="{% url profile_detail exp_member.username %}" title="{{ exp_member.username }}">{{ exp_member.username }}</a>, </span>
                                {% endfor %}
                            {% else %}
                                <p><b>Nobody</b>. Only YOU can see this dataset.</p>
                            {% endif %}
                        {% endif %}
                        <p>Please note, it's always ONLY YOUR exclusive right to MANAGE the dataset, changing its properties and collection of files.</p>
                    {% endif %}
                </div>
            
                <div class="friends">
                    <h2>{% trans "Linked to:" %}</h2>
                    {% if dataset.in_projects.all %}
                    <table width="100%" style="margin-bottom: 10px;">
                        <thead>
                            <tr><th align="left">Projects</th></tr>
                        </thead>
                        {% for obj in dataset.in_projects.all %}
                            <tr><td>- <a href="{{ obj.get_absolute_url }}">{{ obj.slug|truncate_dot:26|escape }}</a></td></tr>
                        {% endfor %}
                    </table>
                    {% endif%} 
                    {% if exprts %}
                    <table width="100%" style="margin-bottom: 10px;">
                        <thead>
                            <tr><th align="left">Experiments</th></tr>
                        </thead>
                        {% for experiment in exprts %}
                            <tr><td>- <a href="{{ experiment.get_absolute_url }}">{{ experiment.title|truncate_dot:26|escape }}</a></td></tr>
                        {% endfor %}
                    </table>
                    {% endif%} 
                    {% if exprts or dataset.in_projects.all %}
                    {% else %}
                        <p>This Dataset is not linked to any object in the system.</p>
                    {% endif%}
                    <p>You may link objects using the metadata "sections" from the object's details page.</p>
                </div>
            </div>
        {% endifequal %}    
    
    <div class="left_panel">
        <div class="photo-title">
            <h2>Dataset: {{ dataset.title }} {% if not dataset.isActive %}(DELETED){% endif %}</h2>
        </div>
        <div id="datasethead">
	        <table>
	          <tbody>
	          <tr>
	            <td><strong>Description:</strong></td>
	            <td>{{ dataset.caption }}</td>
	          </tr>
	          <tr>
	            <td><strong>Date Created:</strong> </td>
	            <td>{{ dataset.date_added|date:"Y-m-d H:i" }}</td>
	          </tr>
	          <tr>
	            <td><strong>Objects Totals:</strong> </td>
	            <td>{{ dataset.objects_count_str }}</td>
	          </tr>
{% comment %}
	          <tr>
	            <td><strong>Volume (linked files):</strong> </td>
	            <td>{{ dataset.file_volume_count|filesizeformat }}</td>
	          </tr>
{% endcomment %}
	          {% ifnotequal dataset.owner request.user%}
		          <tr>
		            <td><strong>Owner:</strong></td>
		            <td><a href="{% url profile_detail dataset.owner.username %}">{{ dataset.owner.username }}</a></td>
		          </tr>
	          {% endifnotequal %}
	          <tr>
	            <td><strong>&nbsp;</strong></td>
	            <td>{% show_tags_for dataset %}</td>
	          </tr>	          
		     </tbody>
		   </table>
        </div>  

        {% ifequal request.user dataset.owner %}
            <div class="form-toggle">
                <p><span id="edit-details-toggle">{% trans "Edit details" %}</span>
                <span id="change-privacy-toggle">{% trans "Privacy Settings" %}</span></p>
            {% with dataset_form as edit_form %}
                {% include "state_machine/edit_details.html" %}
            {% endwith %}

            {% with privacy_form as privacy_form %}
                {% include "state_machine/edit_privacy.html" %}
            {% endwith %}
            </div>
        {% endifequal %}
    </div>

    {% if dataset.has_metadata %}
    <h2>{% trans "Related Data and Metadata" %}</h2>

    {% with dataset as tree_container %}
    {% ifequal request.user dataset.owner %}
        {% comment %} PAPA is used to indicate which metadata buttons to render, depending on object type {% endcomment %}
        {% with "dataset" as papa %}
        <p>Please use the area below to organize Data in this Dataset - create sections you need, link Files or Time Series, or add Metadata properties. You may build any tree structure that is required for the Dataset. Use properties as Metadata descriptors. Search, copy and paste functions may help you to save time.</p>
            {% include "metadata/section_buttons.html" %}
        {% endwith %}
        <div id="form-add-section" style="padding: 0; margin: 0; display:none">
            {% include "metadata/section_add.html" %}
            <div id="default_properties_area" style="height: 209px; width: 500px; padding-left: 10px; overflow: auto;">
                {% include "metadata/properties_list.html" %}
            </div>
        </div>
    {% endifequal %}

    <div style="padding: 6px 0px 0px 0px; margin: 0;">
            {% include "metadata/sections_tree.html" %}
        <div id="properties_area" style="width: 515px; padding-left: 210px">
            {% include "metadata/properties_list.html" %}
        </div>
    </div>
    {% endwith %}

    {% else %}
    {% ifequal request.user dataset.owner %}
    <p>This Dataset has no DATA or METADATA yet. Please link Files or Time Series, as well as metadata using odML sections and properties. Start by <a href="#" onclick="add_root_section({{ dataset.id }}, 2)">adding a root section</a> now.</p>
    {% endifequal %}
    {% endif %}


     {% else %}
    <p>No data about this dataset is found.</p>
    {% endif %}

{% endblock %}

{% block extra_body %}
    <script type="text/javascript" src="{{ STATIC_URL }}js/clear_selection.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/add_root_section.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/edit_details_privacy.js"></script>

    {% if dataset.has_metadata %}
    <script type="text/javascript" src="{{ STATIC_URL }}js/jquery.tree.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/delete_metadata_items.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/edit_property.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/add_metadata_items.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/hide_metadata_forms.js"></script>
    {% with dataset as tree_container %}
        {% include "metadata/load_meta_tree.html" %}
    {% endwith %}
    <script type="text/javascript">
        $(document.getElementById("sections")).ready(function() {
        // 3 - Section
            load_meta_tree(3);
            load_default_meta_tree(3);
            $('#add-property-toggle').click(function() {
                hide_metadata_forms("add-property");
                $('#add-property').toggle();
                return false;
            });
            if ($('#add-property .error').length) {
                $('#add-property').show();
                $('#add-property .error').autoscroll();
            };
            $('#link-datafile-toggle').click(function() {
                hide_metadata_forms("add-datafile");
                $('#add-datafile').toggle();
                return false;
            });
            $('#link-timeseries-toggle').click(function() {
                hide_metadata_forms("add-timeseries");
                $('#add-timeseries').toggle();
                return false;
            });
            $('#import-odml-toggle').click(function() {
                hide_metadata_forms("import-odml");
                $('#add-odml').toggle();
                return false;
            });
            //$("#sections").jstree("select_node", "#test2");
            $('#add-datafile').show();
            $.tree.focused().select_branch("#"+{{ first_section_id }});
        });
    </script>
    {% endif %}
{% endblock %}
