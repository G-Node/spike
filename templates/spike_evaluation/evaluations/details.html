{% extends "spike_evaluation/benchmarks/base.html" %}

{% load i18n %}
{% load uni_form %}
{% load pagination_tags %}
{% load extra_tagging_tags %}
{% load truncate_filter %}
{% load theme_tags %}

{% block head_title %}{{ b.name }}{% endblock %}

{% block body %}
    <div class="right_panel">
        <div class="members">
            {% if e.processed %}
                <p>True positive: {{ er.TP }}%</p>
                <p>False positive: {{ er.FP }}%</p>
            {% else %}
                <p>The evaluation results are not available yet.</p>
            {% endif %}
        </div>
    </div>

<div class="left_panel">
<div class="photo-title">
    <h2>Evaluation {{ e.id }} (Benchmark {{ e.benchmark.name }}){% if e.is_public %} - published{% endif %}</h2>
</div>

<div id="datasethead">
    <table>
      <tbody>
      <tr>
        <td><strong>Algorithm:</strong></td>
        <td>{{ e.algorithm }}</td>
      </tr>
      <tr>
        <td><strong>Description:</strong></td>
        <td>{{ e.description }}</td>
      </tr>
      <tr>
        <td><strong>Date Created:</strong> </td>
        <td>{{ e.date_created|date }}</td>
      </tr>
      {% ifnotequal e.owner request.user %}
          <tr>
            <td><strong>Owner:</strong></td>
            <td><a href="{% url profile_detail e.owner.username %}">{{ e.owner.username }}</a></td>
          </tr>
      {% endifnotequal %}
      </tbody>
      <tr>
        <td><strong>Processing state:</strong> </td>
        <td>
        {% ifequal e.processing_state 0 %}<b style="color: blue">in progress</b>{% endifequal %}
        {% ifequal e.processing_state 1 %}<b style="color: green">success</b>{% endifequal %}
        {% ifequal e.processing_state 2 %}<b style="color: red">failed</b> with the message "{{ e.error }}"{% endifequal %}
        </td>
      </tr>
   </table>
</div>  

{% if e.processed %}

{% if user.is_authenticated %}
    {% ifequal e.owner user %}
        {% if not e.is_public %}
            <p>{% silk "status_busy" %} <a href="#" onclick="$('#change_privacy_form').toggle(); return false;">{% trans "Make it Public" %}</a><p>
            <form class="delete_form" id="change_privacy_form" action="" method="POST" style="display: none;">
                <input type="hidden" name="action" value="switch" />
                <input type="submit" value="{% trans "Publish evaluation" %}" />
            </form>
        {% else %}
            <p>{% silk "status_online" %} <a href="#" onclick="$('#change_privacy_form').toggle(); return false;">{% trans "Retreat to Private" %}</a><p>
            <form class="delete_form" id="change_privacy_form" action="" method="POST" style="display: none;">
                <input type="hidden" name="action" value="switch" />
                <input type="submit" value="{% trans "Make this evaluation Private" %}" />
            </form>
        {% endif %}
    {% endifequal %}
{% endif %}

<p>Evaluation results:</p>

<table name="results" class="messages">
    <thead>
        <tr>
            <th rowspan=3>{% trans "GT Unit" %}</th>
            <th rowspan=3>{% trans "Found Unit" %}</th>
            <th colspan=3>{% trans "Ground Truth" %}</th>
            <th colspan=3>{% trans "Found Spikes of Unit" %}</th>
            <th colspan=3>{% trans "False Positives" %}</th>
            <th colspan=4>{% trans "False Negatives" %}</th>
        </tr>
        <tr>
            <!-- Attention: rowspan -->
            <th colspan=3>{% trans "(True Spikes)" %}</th>
            <th colspan=3>{% trans "(True Positives)" %}</th>
            <th colspan=2>{% trans "Other Spikes" %}</th>
            <th colspan=1>{% trans "Noise" %}</th>
            <th colspan=2>{% trans "Found by other Unit" %}</th>
            <th colspan=2>{% trans "Not detected" %}</th>
        </tr>
        <tr>
            <!-- Attention: rowspan -->
            <th>{% trans "Total" %}</th>
            <th>{% trans "N-O" %}</th>
            <th>{% trans "O" %}</th>
            <th>{% trans "Total" %}</th>
            <th>{% trans "N-O" %}</th>
            <th>{% trans "O" %}</th>
            <th>{% trans "N-O" %}</th>
            <th>{% trans "O" %}</th>
            <th>{% trans "FP" %}</th>
            <th>{% trans "N-O" %}</th>
            <th>{% trans "O" %}</th>
            <th>{% trans "N-O" %}</th>
            <th>{% trans "O" %}</th>
        </tr>
    </thead>
    <tfoot>
        <tr><td colspan="15"><span style="color: red;">*</span>: GT = Ground Truth, O = Overlaps, N-O = Non-Overlaps</td></tr>
    </tfoot>
    <tbody>
    {% for r in er %}
        <tr>
        {% for v in r.display %}
            <td>{{ v }}</td>
        {% endfor %}
        </tr>
    {% endfor %}
    </tbody>
</table>


<p>Evaluation summary:</p>

<table name="summary" class="messages">
    <thead>
        <tr>
            <th colspan=3>{% trans "Detection Errors" %}</th>
            <th colspan=4 rowspan=2>{% trans "Classification Errors" %}</th>
        </tr>
        <tr>
            <th colspan=1>{% trans "False positives" %}</th>
            <th colspan=3>{% trans "False Negatives" %}</th>
            <!-- Attention: rowspan -->
        </tr>
        <tr>
            <!-- Attention: rowspan -->
            <th>{% trans "Total" %}</th>
            <th>{% trans "Total" %}</th>
            <th>{% trans "Non-Overlaps" %}</th>
            <th>{% trans "Overlaps" %}</th>
            <th>{% trans "Total" %}</th>
            <th>{% trans "Non-Overlaps" %}</th>
            <th>{% trans "Overlaps" %}</th>
        </tr>
    </thead>
    <tbody>
        <tr>
        {% for v in e.display %}
            <td>{{ v }}</td>
        {% endfor %}
        </tr>
    </tbody>
</table>

<table name="summary" class="messages">
    <tbody>
        {% for img_obj in image_results %}
        <tr>
            <td><h2>{{ img_obj.img_type }}</h2><br>
            <img src="{{ img_obj.img_data.url }}" /></td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% endif %}
</div>
{% endblock %}

