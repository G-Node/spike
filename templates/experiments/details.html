{% extends "experiments/base.html" %}

{% load i18n %}
{% load humanize %}
{% load uni_form %}
{% load tagging_tags %}
{% load truncate_filter %}
{% load extra_tagging_tags %}

{% block head_title %}{% blocktrans %}Experiment Details{% endblocktrans %}{% endblock %}

{% block extra_head %}
	<link type="text/css" rel="stylesheet" href="{{ STATIC_URL }}css/shCore.css"/> 
	<link type="text/css" rel="stylesheet" href="{{ STATIC_URL }}css/shThemeDefault.css"/>
	<link type="text/css" rel="stylesheet" href="{{ STATIC_URL }}css/shTreeDemo.css"/>  
{% endblock %}

{% block body %}

    {% if experiment %}

        {% ifequal experiment.owner request.user %}
            <div class="right_panel">
                <div class="friends">
                    {% if experiment.is_Public %}
                    <h2>{% trans "Privacy" %}</h2>
                    <p>This experiment is <b style="color: red">Public</b> and available for other users. Your data, attached to the experiment, has specific privacy settings and may NOT be accessible to others.</p>
                    {% else %}
                    <h2>{% trans "Shared with:" %}</h2>
                        {% if experiment.is_Friendly %}
                            <p>All people you know
                            {% if experiment.shared_with.all %}
                            , and </p>
                                {% for exp_member in experiment.shared_with.all %}
                                        <span><a href="{% url profile_detail exp_member.username %}" title="{{ exp_member.username }}">{{ exp_member.username }}</a>, </span>
                                {% endfor %}
                            {% else %}
                                .</p>
                            {% endif %}
                        {% else %}
                            {% if experiment.shared_with.all %}
                                {% for exp_member in experiment.shared_with.all %}
                                        <span><a href="{% url profile_detail exp_member.username %}" title="{{ exp_member.username }}">{{ exp_member.username }}</a>, </span>
                                {% endfor %}
                            {% else %}
                                <p><b>Nobody</b>. Only YOU can see this experiment.</p>
                            {% endif %}
                        {% endif %}
                        <p>Please note, it's always ONLY YOUR exclusive right to MANAGE the experiment, changing its properties, results, assigned files and datasets.</p>
                    {% endif %}
                </div>

                <div class="friends">
                    <h2>{% trans "Linked to:" %}</h2>
                    {% if experiment.in_projects.all %}
                    <table width="100%" style="margin-bottom: 10px;">
                        <thead>
                            <tr><th align="left">Projects</th></tr>
                        </thead>
                        {% for project in experiment.in_projects.all %}
                            <tr><td>- <a href="{{ project.get_absolute_url }}">{{ project.slug|truncate_dot:26|escape }}</a></td></tr>
                        {% endfor %}
                    </table>
                    {% else %}
                        <p>This Experiment is not linked to any Project in the system.</p>
                    {% endif%}
                    <p>You may link objects using the metadata "sections" from the object's details page.</p>
                </div>


            </div>
        {% endifequal %}

    <div class="left_panel">
        <div class="photo-title">
            <h2>{{ experiment.title }} {% if not experiment.isActive %}(DELETED){% endif %}</h2>
        </div>

        <div id="experimenthead">
	        <table>
	          <tbody><tr>
	            <td><strong>Description:</strong></td>
	            <td>{{ experiment.caption }}</td>
	          </tr>
	          <tr>
	            <td><strong>Date created:</strong> </td>
	            <td>{{ experiment.date_created|date:"Y-m-d H:i" }}</td>
	          </tr>
	          {% ifnotequal experiment.owner request.user%}
	          	<tr>
	              <td><strong>Owner:</strong></td>
	              <td><a href="{% url profile_detail experiment.owner.username %}">{{ experiment.owner.username }}</a></td>
	            </tr>
	          {% endifnotequal %}
	          <tr>
	            <td><strong>&nbsp;</strong></td>
	            <td>{% show_tags_for experiment %}</td>
	          </tr> 
	         </tbody></table>
         </div>
        
        {% ifequal request.user experiment.owner %}
            <div class="form-toggle">
                <p><span id="edit-details-toggle">{% trans "Edit details" %}</span>
                <span id="change-privacy-toggle">{% trans "Privacy Settings" %}</span></p>
            {% with exp_form as edit_form %}
                {% include "state_machine/edit_details.html" %}
            {% endwith %}

            {% with privacy_form as privacy_form %}
                {% include "state_machine/edit_privacy.html" %}
            {% endwith %}
            </div>
        {% endifequal %}
    </div>
    
    {% if experiment.has_metadata %}
    <h2>{% trans "Related Data and Metadata" %}</h2>

        {% with experiment as tree_container %}
        {% ifequal request.user experiment.owner %}
            {% comment %} PAPA is used to indicate which metadata buttons to render, depending on object type {% endcomment %}
            {% with "experiment" as papa %}
            <p>Please use the area below to link data and annotate your experiment, using odML sections and properties. You may build a tree of sections according to the structure of your Experiment, and link Datasets, Files or Time Series to any place within it. Use properties as metadata descriptors. Search, copy and paste functions may help you to save time.</p>
                {% include "metadata/section_buttons.html" %}
            {% endwith %}
            <div id="form-add-section" style="padding: 0; margin: 0; display:none">
                {% include "metadata/section_add.html" %}
                <div id="default_properties_area" style="height: 207px; width: 500px; padding-left: 10px; overflow: auto;">
                    {% include "metadata/properties_list.html" %}
                </div>
            </div>
        {% endifequal %}

        <div style="padding: 6px 0px 0px 0px; margin: 0;">
                {% include "metadata/sections_tree.html" %}
            <div id="properties_area" style="width: 515px; padding-left: 210px">
                {% include "metadata/properties_list.html" %}
            </div>
        </div>
        {% endwith %}


    {% else %}
        {% ifequal request.user experiment.owner %}
            <p>You don't have any DATA or METADATA assigned to this experiment. You may start linking DATA and / or annotating your experiment using odML sections and properties. Start by <a href="#" onclick="add_root_section({{ experiment.id }}, 1)">adding a root section</a> now.</p>
        {% endifequal %}
    {% endif %}

    {% else %}
    <p>No data about this experiment is found.</p>
    {% endif %}
    
{% endblock %}

{% block extra_body %}
    <script type="text/javascript" src="{{ STATIC_URL }}js/clear_selection.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/add_root_section.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/edit_details_privacy.js"></script>

    {% if experiment.has_metadata %}
    <script type="text/javascript" src="{{ STATIC_URL }}js/jquery.tree.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/delete_metadata_items.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/edit_property.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/add_metadata_items.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/hide_metadata_forms.js"></script>
    {% with experiment as tree_container %}
        {% include "metadata/load_meta_tree.html" %}
    {% endwith %}
    <script type="text/javascript">
        $(document.getElementById("sections")).ready(function() {
        // 3 - Section
            load_meta_tree(3);
            load_default_meta_tree(3);
            $('#add-property-toggle').click(function() {
                hide_metadata_forms("add-property");
                $('#add-property').toggle();
                return false;
            });
            if ($('#add-property .error').length) {
                $('#add-property').show();
                $('#add-property .error').autoscroll();
            };
            $('#link-dataset-toggle').click(function() {
                hide_metadata_forms("add-dataset");
                $('#add-dataset').toggle();
                return false;
            });
            $('#link-datafile-toggle').click(function() {
                hide_metadata_forms("add-datafile");
                $('#add-datafile').toggle();
                return false;
            });
            $('#link-timeseries-toggle').click(function() {
                hide_metadata_forms("add-timeseries");
                $('#add-timeseries').toggle();
                return false;
            });
            $('#import-odml-toggle').click(function() {
                hide_metadata_forms("import-odml");
                $('#add-odml').toggle();
                return false;
            });
            $.tree.focused().select_branch("#"+{{ first_section_id }});
        });
    </script>
    {% endif %}
{% endblock %}
